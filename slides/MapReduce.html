<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>MapReduce</title>
<!-- 2014-04-08 Tue 03:30 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<meta name="generator" content="Org-mode"/>
<meta name="author" content="Jim Blomo"/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="production/common.css" />
<link rel="stylesheet" type="text/css" href="production/screen.css" media="screen" />
<link rel="stylesheet" type="text/css" href="production/projection.css" media="projection" />
<link rel="stylesheet" type="text/css" href="production/color-blue.css" media="projection" />
<link rel="stylesheet" type="text/css" href="production/presenter.css" media="presenter" />
<link href='http://fonts.googleapis.com/css?family=Lobster+Two:700|Yanone+Kaffeesatz:700|Open+Sans' rel='stylesheet' type='text/css'>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012  Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">MapReduce</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Snakes on a Hadoop</a></li>
<li><a href="#sec-2">2. Let's Jump In</a>
<ul>
<li><a href="#sec-2-1">2.1. Versions</a></li>
</ul>
</li>
<li><a href="#sec-3">3. Agenda</a>
<ul>
<li><a href="#sec-3-1">3.1. Sections</a></li>
</ul>
</li>
<li><a href="#sec-4">4. Interest?</a>
<ul>
<li><a href="#sec-4-1">4.1. Audience participation!</a></li>
</ul>
</li>
<li><a href="#sec-5">5. Run a Test</a></li>
<li><a href="#sec-6">6. Yelp has a problem</a>
<ul>
<li><a href="#sec-6-1">6.1. Too long</a></li>
</ul>
</li>
<li><a href="#sec-7">7. Solution?</a>
<ul>
<li><a href="#sec-7-1">7.1. New Challenges</a></li>
</ul>
</li>
<li><a href="#sec-8">8. Do It Yourself</a>
<ul>
<li><a href="#sec-8-1">8.1. Dependencies</a></li>
</ul>
</li>
<li><a href="#sec-9">9. Big Idea</a>
<ul>
<li><a href="#sec-9-1">9.1. Really Big Idea</a></li>
</ul>
</li>
<li><a href="#sec-10">10. MapReduce</a>
<ul>
<li><a href="#sec-10-1">10.1. Reading</a></li>
<li><a href="#sec-10-2">10.2. Example</a>
<ul>
<li><a href="#sec-10-2-1">10.2.1. Details</a></li>
</ul>
</li>
<li><a href="#sec-10-3">10.3. Map</a></li>
<li><a href="#sec-10-4">10.4. Map Example</a>
<ul>
<li><a href="#sec-10-4-1">10.4.1. Counts</a></li>
</ul>
</li>
<li><a href="#sec-10-5">10.5. Status?</a>
<ul>
<li><a href="#sec-10-5-1">10.5.1. Middle Step</a></li>
</ul>
</li>
<li><a href="#sec-10-6">10.6. Reduce</a>
<ul>
<li><a href="#sec-10-6-1">10.6.1. Value*s*</a></li>
</ul>
</li>
<li><a href="#sec-10-7">10.7. Reduce Example</a>
<ul>
<li><a href="#sec-10-7-1">10.7.1. Details</a></li>
</ul>
</li>
<li><a href="#sec-10-8">10.8. Example Output</a></li>
</ul>
</li>
<li><a href="#sec-11">11. Point?</a>
<ul>
<li><a href="#sec-11-1">11.1. Details</a></li>
<li><a href="#sec-11-2">11.2. Implementation</a></li>
<li><a href="#sec-11-3">11.3. Intermediate</a></li>
<li><a href="#sec-11-4">11.4. "Shuffle"</a></li>
<li><a href="#sec-11-5">11.5. Distribute</a></li>
<li><a href="#sec-11-6">11.6. Inputs</a>
<ul>
<li><a href="#sec-11-6-1">11.6.1. Splitting Files</a></li>
</ul>
</li>
<li><a href="#sec-11-7">11.7. Incorrect Log Style</a>
<ul>
<li><a href="#sec-11-7-1">11.7.1. No!</a></li>
</ul>
</li>
<li><a href="#sec-11-8">11.8. Correct Log Style</a></li>
</ul>
</li>
<li><a href="#sec-12">12. Data</a>
<ul>
<li><a href="#sec-12-1">12.1. Format</a></li>
</ul>
</li>
<li><a href="#sec-13">13. mrjob</a>
<ul>
<li><a href="#sec-13-1">13.1. Relation to HW</a></li>
<li><a href="#sec-13-2">13.2. Output</a></li>
<li><a href="#sec-13-3">13.3. Running</a></li>
</ul>
</li>
<li><a href="#sec-14">14. Pages with &gt; 400 visits</a>
<ul>
<li><a href="#sec-14-1">14.1. Demo</a></li>
</ul>
</li>
<li><a href="#sec-15">15. <b>BREAK</b></a></li>
<li><a href="#sec-16">16. Solution</a></li>
<li><a href="#sec-17">17. Discussion: User Visits</a></li>
<li><a href="#sec-18">18. Transform Data</a>
<ul>
<li><a href="#sec-18-1">18.1. Not covered</a></li>
</ul>
</li>
<li><a href="#sec-19">19. Most Common Title Words</a></li>
<li><a href="#sec-20">20. Joins</a></li>
<li><a href="#sec-21">21. Running Programatically</a></li>
<li><a href="#sec-22">22. MRJob Class</a>
<ul>
<li><a href="#sec-22-1">22.1. Example</a></li>
</ul>
</li>
<li><a href="#sec-23">23. <b>BREAK</b></a></li>
<li><a href="#sec-24">24. Solution</a></li>
<li><a href="#sec-25">25. Yelp Data</a>
<ul>
<li><a href="#sec-25-1">25.1. More Data</a></li>
</ul>
</li>
<li><a href="#sec-26">26. Multi-Step</a>
<ul>
<li><a href="#sec-26-1">26.1. Output as Input</a></li>
<li><a href="#sec-26-2">26.2. Examples</a></li>
<li><a href="#sec-26-3">26.3. PageRank</a></li>
</ul>
</li>
<li><a href="#sec-27">27. Unique Review</a>
<ul>
<li><a href="#sec-27-1">27.1. Questions</a></li>
<li><a href="#sec-27-2">27.2. Step 2: Count Unique Words</a></li>
<li><a href="#sec-27-3">27.3. Questions</a></li>
</ul>
</li>
<li><a href="#sec-28">28. INPUT<sub>PROTOCOL</sub></a>
<ul>
<li><a href="#sec-28-1">28.1. Examples</a></li>
</ul>
</li>
<li><a href="#sec-29">29. <b>BREAK</b></a></li>
<li><a href="#sec-30">30. Solution</a></li>
<li><a href="#sec-31">31. Jaccard Coefficient</a>
<ul>
<li><a href="#sec-31-1">31.1. Jaccard</a></li>
</ul>
</li>
<li><a href="#sec-32">32. Write user\<sub>similarity</sub>.py</a></li>
<li><a href="#sec-33">33. <b>BREAK</b></a></li>
<li><a href="#sec-34">34. Solution</a>
<ul>
<li><a href="#sec-34-1">34.1. Efficiency</a></li>
</ul>
</li>
<li><a href="#sec-35">35. EMR</a></li>
<li><a href="#sec-36">36. Elastic MapReduce</a></li>
<li><a href="#sec-37">37. mrjob provides</a></li>
<li><a href="#sec-38">38. How To</a></li>
<li><a href="#sec-39">39. Settings</a></li>
<li><a href="#sec-40">40. Bootstrap</a></li>
<li><a href="#sec-41">41. Book Keeping</a></li>
<li><a href="#sec-42">42. Tracking</a></li>
<li><a href="#sec-43">43. EMR Pricing</a>
<ul>
<li><a href="#sec-43-1">43.1. Typical usage</a></li>
<li><a href="#sec-43-2">43.2. Job Flow Pooling</a>
<ul>
<li><a href="#sec-43-2-1">43.2.1. Pooling</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-44">44. mrjob Workflow</a></li>
<li><a href="#sec-45">45. Thank You!</a></li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Snakes on a Hadoop&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>PyCon 2014
</li>
<li>Jim Blomo
</li>
<li><a href="https://jblomo.github.io/pycon-mrjob/slides/MapReduce.html#sec-1">https://jblomo.github.io/pycon-mrjob/slides/MapReduce.html#sec-1</a>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Let's Jump In&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">

<pre class="src src-shell">git clone https://github.com/jblomo/pycon-mrjob.git
virtualenv venv
. venv/bin/activate
pip install -r requirements.txt
</pre>
</div>
</div>
<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> Versions&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>All tests were done with Python 2.7
</li>
<li>This is what is used on AWS EMR, so we're going to try to keep versions
compatible.
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Agenda&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>What is MapReduce?
</li>
<li>Writing MapReduce in mrjob
</li>
<li>Exercise 1, user activity
</li>
<li>Joins and Programmatic usage
</li>
<li>Exercise 2, self-joins
</li>
<li>Multi-step jobs &amp; Protocols
</li>
<li>Exercise 3, finding Yelp reviews with unique words
</li>
<li>Exploring user-user similarity
</li>
<li>Exercise 4, putting it all together
</li>
<li>Deploying on AWS
</li>
</ul>
</div>
<div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Sections&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>I will give some background, answer questions (35 minutes)
</li>
<li>I'll introduce a script (5 minutes)
</li>
<li>The exercise will have audience extending the script to get it working (15 minutes)
</li>
<li>We'll go over an example solution (5 minutes)
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Interest?&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>What are you interested in?
</li>
<li>What are you hoping to get out of this talk?
</li>
</ul>
</div>
<div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> Audience participation!&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h3>
<div class="outline-text-3" id="text-4-1">
<ul class="org-ul">
<li>This will help focus this talk
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Run a Test&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-5">
<div class="org-src-container">

<pre class="src src-html">python venv/lib/python2.7/site-packages/mrjob/examples/mr_word_freq_count.py requirements.txt
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Yelp has a problem&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-6">
<ul class="org-ul">
<li>250+ GB of logs per day
</li>
<li>Each GB takes 10 minutes to process
</li>
<li>How long to handle a day's logs?
</li>
</ul>

<div class="figure">
<p><img src="img/yelp-growth.png"  alt="yelp-growth.png"/></p>
</div>
</div>
<div id="outline-container-sec-6-1" class="outline-3">
<h3 id="sec-6-1"><span class="section-number-3">6.1</span> Too long&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h3>
<div class="outline-text-3" id="text-6-1">
<ul class="org-ul">
<li>On a single machine 40+ hours!
</li>
<li>If we really had only a single machine, we wouldn't be able to keep up!
</li>
<li>Mistake can't be fixed in a day (billing especially important)
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> Solution?&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span>&#xa0;<span class="animate">animate</span></span></h2>
<div class="outline-text-2" id="text-7">
<ul class="org-ul">
<li>Don't use one machine!
</li>
<li>What are the new challenges?
</li>
<li>Distributing data
</li>
<li>Calculating overall statistics
</li>
<li>Failures
</li>
</ul>
</div>
<div id="outline-container-sec-7-1" class="outline-3">
<h3 id="sec-7-1"><span class="section-number-3">7.1</span> New Challenges&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h3>
<div class="outline-text-3" id="text-7-1">
<ul class="org-ul">
<li>With many machines, how to they get access to the 100 GB of logs?
</li>
<li>How do they coordinate who gets which section of logs?
</li>
<li>How do we calculate the average?
</li>
<li>What happens when one of the boxes dies?
<ul class="org-ul">
<li>Detecting failure (timeout waiting for data? Out of band?)
</li>
<li>Decide who takes over the data
</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> Do It Yourself&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span>&#xa0;<span class="two_col">two_col</span></span></h2>
<div class="outline-text-2" id="text-8">
<ul class="org-ul">
<li>There are many ways to deal with these challenges
</li>
<li>Often, people would "roll" their own solutions depending on the problem
</li>
<li>Google implemented a generic solution, shared idea
</li>
</ul>

<div class="figure">
<p><img src="img/mapreduce-paper.png"  alt="mapreduce-paper.png"/></p>
</div>
</div>
<div id="outline-container-sec-8-1" class="outline-3">
<h3 id="sec-8-1"><span class="section-number-3">8.1</span> Dependencies&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h3>
<div class="outline-text-3" id="text-8-1">
<ul class="org-ul">
<li>Did you have a super-computer?
</li>
<li>What programming language were you using?
</li>
<li>Type of problem being solved (working on graphs, or web logs, &#x2026;)
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9"><span class="section-number-2">9</span> Big Idea&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-9">
<ul class="org-ul">
<li>Simplify, limit solution expression
</li>
<li>Enable sophisticated implementation
</li>
</ul>


<ul class="org-ul">
<li>Interface: Map() Reduce()
</li>
<li>Implementation: Reliably run over 1000s of machines
</li>
</ul>
</div>
<div id="outline-container-sec-9-1" class="outline-3">
<h3 id="sec-9-1"><span class="section-number-3">9.1</span> Really Big Idea&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h3>
<div class="outline-text-3" id="text-9-1">
<ul class="org-ul">
<li>Limiting yourself to what can be expressed may seem like a loss
</li>
<li>But it enables the implementation to handle the problems we talked about
</li>
<li>And then can be used as understandable building blocks
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-10" class="outline-2">
<h2 id="sec-10"><span class="section-number-2">10</span> MapReduce&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-10">
<dl class="org-dl">
<dt> Map </dt><dd>Extract a property to summarize over
</dd>
<dt> Reduce </dt><dd>Summarize all items with a particular propery
</dd>
</dl>


<ul class="org-ul">
<li>Simple: Each operation stateless
</li>
</ul>
</div>
<div id="outline-container-sec-10-1" class="outline-3">
<h3 id="sec-10-1"><span class="section-number-3">10.1</span> Reading&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h3>
<div class="outline-text-3" id="text-10-1">
<ul class="org-ul">
<li>MapReduce's main benefits are for running over many machines, fault
tolerance
</li>
<li>But we'll just practice on one machine
</li>
<li>Then see how to run in the cloud
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-10-2" class="outline-3">
<h3 id="sec-10-2"><span class="section-number-3">10.2</span> Example&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-10-2">
<ul class="org-ul">
<li>URL Shortener
</li>
<li>How many actions have we seen?
</li>
<li>Redirects: 450, Saves: 40, Loads: 60
</li>
</ul>
</div>
<div id="outline-container-sec-10-2-1" class="outline-4">
<h4 id="sec-10-2-1"><span class="section-number-4">10.2.1</span> Details&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h4>
<div class="outline-text-4" id="text-10-2-1">
<dl class="org-dl">
<dt> Redirects </dt><dd>How many times have we expanded a short link to a long one?
</dd>
<dt> Saves </dt><dd>How many times have we saved a new URL?
</dd>
<dt> Loads </dt><dd>How many times have we just loaded the front page?
</dd>
<dt> First </dt><dd>So first step in MapReduce is what?
</dd>
</dl>
</div>
</div>
</div>
<div id="outline-container-sec-10-3" class="outline-3">
<h3 id="sec-10-3"><span class="section-number-3">10.3</span> Map&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-10-3">
<dl class="org-dl">
<dt> Input </dt><dd>Key, Value
</dd>
<dt> Output </dt><dd>Keys, Values
</dd>
</dl>
</div>
</div>
<div id="outline-container-sec-10-4" class="outline-3">
<h3 id="sec-10-4"><span class="section-number-3">10.4</span> Map Example&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-10-4">
<dl class="org-dl">
<dt> Input Key </dt><dd>Log line number
</dd>
<dt> Input Value </dt><dd>Log line text
</dd>
<dt> Output Key </dt><dd>Action
</dd>
<dt> Output Value </dt><dd>times this action has occurred on this line
</dd>
</dl>
</div>
<div id="outline-container-sec-10-4-1" class="outline-4">
<h4 id="sec-10-4-1"><span class="section-number-4">10.4.1</span> Counts&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h4>
<div class="outline-text-4" id="text-10-4-1">
<ul class="org-ul">
<li>Log line number is not helpful in our specific case
</li>
<li>Log line text: we hope it is machine readable so we can accurately extract
the action
</li>
<li>It has datetime, cookie, action, etc.
</li>
<li>How many times has this action occurred? 1
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-10-5" class="outline-3">
<h3 id="sec-10-5"><span class="section-number-3">10.5</span> Status?&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-10-5">
<div class="org-src-container">

<pre class="src src-text">load            1
save            1
redirect        1
redirect        1
load            1
redirect        1
load            1
save            1
redirect        1
</pre>
</div>
</div>
<div id="outline-container-sec-10-5-1" class="outline-4">
<h4 id="sec-10-5-1"><span class="section-number-4">10.5.1</span> Middle Step&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h4>
<div class="outline-text-4" id="text-10-5-1">
<ul class="org-ul">
<li>From log lines, we've extracted the information out that we care about
</li>
<li>The counts and the actions
</li>
<li>Next step summarize
</li>
<li>Next step after Map?
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-10-6" class="outline-3">
<h3 id="sec-10-6"><span class="section-number-3">10.6</span> Reduce&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-10-6">
<dl class="org-dl">
<dt> Input </dt><dd>Key, Values
</dd>
<dt> Output </dt><dd>Keys, Values
</dd>
</dl>
</div>
<div id="outline-container-sec-10-6-1" class="outline-4">
<h4 id="sec-10-6-1"><span class="section-number-4">10.6.1</span> Value*s*&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h4>
<div class="outline-text-4" id="text-10-6-1">
<ul class="org-ul">
<li>Note: The input is values! Plural
</li>
<li>Because we get a key and all of its associated values
</li>
<li>Remind me: what are we trying to get out of this computation?
</li>
<li>So what do you think the output keys are?
</li>
<li>Values?
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-10-7" class="outline-3">
<h3 id="sec-10-7"><span class="section-number-3">10.7</span> Reduce Example&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-10-7">
<dl class="org-dl">
<dt> Input Key </dt><dd>Action
</dd>
<dt> Input Values </dt><dd>Counts: <code>[1,1,1,1]</code>
</dd>
<dt> Output Key </dt><dd>Action
</dd>
<dt> Output Value </dt><dd>Total Count
</dd>
</dl>
</div>
<div id="outline-container-sec-10-7-1" class="outline-4">
<h4 id="sec-10-7-1"><span class="section-number-4">10.7.1</span> Details&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h4>
<div class="outline-text-4" id="text-10-7-1">
<ul class="org-ul">
<li>Action is <b>one of</b> load save redirect
</li>
<li>To get total count, sum all of the counts
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-10-8" class="outline-3">
<h3 id="sec-10-8"><span class="section-number-3">10.8</span> Example Output&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-10-8">
<dl class="org-dl">
<dt> Output Key </dt><dd>Action
</dd>
<dt> Output Value </dt><dd>Total Count
</dd>
</dl>
<div class="org-src-container">

<pre class="src src-html">"redirect"  4
"save"      2
"load"      3
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-11" class="outline-2">
<h2 id="sec-11"><span class="section-number-2">11</span> Point?&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-11">
<ul class="org-ul">
<li>A lot of work for counting!
</li>
<li>More complex calculations can be done this way, eg. PageRank
</li>
<li>Stateless constraint means it can be used across thousands of computers
</li>
</ul>
</div>
<div id="outline-container-sec-11-1" class="outline-3">
<h3 id="sec-11-1"><span class="section-number-3">11.1</span> Details&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h3>
<div class="outline-text-3" id="text-11-1">
<ul class="org-ul">
<li>By only looking at keys and values, can optimize a lot of backend work
</li>
<li>Where to send the results?
</li>
<li>What to do when a computer fails? (Just restart failed part)
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-11-2" class="outline-3">
<h3 id="sec-11-2"><span class="section-number-3">11.2</span> Implementation&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-11-2">
<div class="org-src-container">

<pre class="src src-text">load            1
save            1
redirect        1
redirect        1
load            1
redirect        1
load            1
save            1
redirect        1
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-11-3" class="outline-3">
<h3 id="sec-11-3"><span class="section-number-3">11.3</span> Intermediate&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h3>
<div class="outline-text-3" id="text-11-3">
<ul class="org-ul">
<li>This was the situation after map
</li>
<li>Keys all jumbled
</li>
<li>What Hadoop does is sort them and distribute them to computers
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-11-4" class="outline-3">
<h3 id="sec-11-4"><span class="section-number-3">11.4</span> "Shuffle"&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-11-4">
<div class="org-src-container">

<pre class="src src-text">load            1
load            1
load            1
redirect        1
redirect        1
redirect        1
redirect        1
save            1
save            1
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-11-5" class="outline-3">
<h3 id="sec-11-5"><span class="section-number-3">11.5</span> Distribute&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h3>
<div class="outline-text-3" id="text-11-5">
<ul class="org-ul">
<li>Now it is easy to distribute, and can handle all the <code>load</code> at once
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-11-6" class="outline-3">
<h3 id="sec-11-6"><span class="section-number-3">11.6</span> Inputs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-11-6">
<ul class="org-ul">
<li>MapReduce distributes computing power by distributing input
</li>
<li>Input is distributed by splitting on lines (records)
</li>
<li>You cannot depend on lines being "together" in MapReduce
</li>
</ul>
</div>
<div id="outline-container-sec-11-6-1" class="outline-4">
<h4 id="sec-11-6-1"><span class="section-number-4">11.6.1</span> Splitting Files&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h4>
<div class="outline-text-4" id="text-11-6-1">
<ul class="org-ul">
<li>Image you have a lot of large log files, GB each
</li>
<li>You'd like to let different machines work on the same file
</li>
<li>Split file down the middle, well, at least on a newline
</li>
<li>Enable two separate machines to work on the parts
</li>
<li>You don't know what line came before this one
</li>
<li>You don't know if you will process the next line
</li>
<li>Only view is this line
</li>
<li>Real life slightly more complicated, but mostly hacks around this
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-11-7" class="outline-3">
<h3 id="sec-11-7"><span class="section-number-3">11.7</span> Incorrect Log Style&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-11-7">
<ul class="org-ul">
<li>URL Shortener logging
</li>
</ul>
<div class="org-src-container">

<pre class="src src-python">app.logger.info(<span style="color: #8b2252;">"Handling request for "</span> + cookie)
...
<span style="color: #b22222;"># find redirect</span>
...
app.logger.info(<span style="color: #8b2252;">"Redirecting to "</span> + destination)
</pre>
</div>
<ul class="org-ul">
<li>Ability to associate the redirect with the
cookie?
<ul class="org-ul">
<li>eg. which cookie had the most redirects?
</li>
</ul>
</li>
</ul>
</div>
<div id="outline-container-sec-11-7-1" class="outline-4">
<h4 id="sec-11-7-1"><span class="section-number-4">11.7.1</span> No!&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h4>
<div class="outline-text-4" id="text-11-7-1">
<ul class="org-ul">
<li>Must log everything on same line
</li>
<li>One machine could have the "Handling request.." Another could have
"Redirecting to&#x2026;"
</li>
<li>Collect it all, then log it
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-11-8" class="outline-3">
<h3 id="sec-11-8"><span class="section-number-3">11.8</span> Correct Log Style&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-11-8">
<ul class="org-ul">
<li>Logging once
</li>
</ul>
<div class="org-src-container">

<pre class="src src-python">log_data[<span style="color: #8b2252;">'cookie'</span>] = cookie
...
<span style="color: #b22222;"># find redirect</span>
log_data[<span style="color: #8b2252;">'action'</span>] = <span style="color: #8b2252;">'redirect'</span>
app.logger.info(json.dumps(log_data))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-12" class="outline-2">
<h2 id="sec-12"><span class="section-number-2">12</span> Data&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-12">
<ul class="org-ul">
<li><a href="http://archive.ics.uci.edu/ml/machine-learning-databases/anonymous/">Anonymous web data from www.microsoft.com</a>
</li>
<li>Contains information in CSV format
</li>
<li>use mrjob MapReduce Framework to find answers
</li>
</ul>
</div>
<div id="outline-container-sec-12-1" class="outline-3">
<h3 id="sec-12-1"><span class="section-number-3">12.1</span> Format&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h3>
</div>
</div>
<div id="outline-container-sec-13" class="outline-2">
<h2 id="sec-13"><span class="section-number-2">13</span> <a href="http://packages.python.org/mrjob/">mrjob</a>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-13">
<div class="org-src-container">

<pre class="src src-html">from mrjob.job import MRJob

class MRWordCounter(MRJob):
    def mapper(self, key, line):
        for word in line.split():
            yield word, 1

    def reducer(self, word, occurrences):
        yield word, sum(occurrences)

if __name__ == '__main__':
    MRWordCounter.run()
</pre>
</div>
<p>
More documentation: <a href="http://pythonhosted.org/mrjob/">http://pythonhosted.org/mrjob/</a>
</p>
</div>
<div id="outline-container-sec-13-1" class="outline-3">
<h3 id="sec-13-1"><span class="section-number-3">13.1</span> Relation to HW&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h3>
<div class="outline-text-3" id="text-13-1">
<ul class="org-ul">
<li><code>mapper</code> takes keys and values
</li>
<li><code>reducer</code> takes the keys output by the mapper, and all relevant values
</li>
<li><code>split</code> takes a string and splits on spaces, giving words
</li>
<li><code>yield</code> essentially returns &lt;key,value&gt; pairs, but can be called more than
once
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-13-2" class="outline-3">
<h3 id="sec-13-2"><span class="section-number-3">13.2</span> Output&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-13-2">
<div class="org-src-container">

<pre class="src src-bash">python code/top_pages.py msanon/anonymous-msweb.data.gz
no configs found; falling back on auto-configuration
creating tmp directory /tmp/top_pages.jim.20121116.052647.278066
...
reading from STDIN
writing to /tmp/top_pages.jim.20121116.052647.278066/step-0-mapper
Counters from step 1:
  (no counters found)
writing to /tmp/top_pages.jim.20121116.052647.278066/step-0-mapper-sorted
writing to /tmp/top_pages.jim.20121116.052647.278066/step-0-reducer
Counters from step 1:
  (no counters found)
Moving /tmp/top_pages.jim.20121116.052647.278066/step-0-reducer -&gt; /tmp/top_pages.jim.20121116.052647.278066/output/part-00000
Streaming final output from /tmp/top_pages.jim.20121116.052647.278066/output
"1000"  912
"1001"  4451
"1002"  749
"1003"  2968
"1004"  8463
"1007"  865
...
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-13-3" class="outline-3">
<h3 id="sec-13-3"><span class="section-number-3">13.3</span> Running&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h3>
<div class="outline-text-3" id="text-13-3">
<ul class="org-ul">
<li>Run with python
</li>
<li>Output some debugging information while it is calculating
</li>
<li>Finally, output results
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-14" class="outline-2">
<h2 id="sec-14"><span class="section-number-2">14</span> Pages with &gt; 400 visits&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-14">
<ul class="org-ul">
<li>Find pages (aka Vroots) with more than 400 visits
</li>
<li>Start off with a template
</li>
</ul>
</div>
<div id="outline-container-sec-14-1" class="outline-3">
<h3 id="sec-14-1"><span class="section-number-3">14.1</span> Demo&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h3>
<div class="outline-text-3" id="text-14-1">
<ul class="org-ul">
<li><code>csv_readline</code> takes in a CSV line, return a list of values
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-15" class="outline-2">
<h2 id="sec-15"><span class="section-number-2">15</span> <b>BREAK</b>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-15">
<ul class="org-ul">
<li>Please complete exercise 1
</li>
<li>Fill in <code>code/top\_pages.py</code>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-16" class="outline-2">
<h2 id="sec-16"><span class="section-number-2">16</span> Solution&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-16">
<ul class="org-ul">
<li><code>git checkout ex1</code>
</li>
<li>yield the vroot ID and the number of times seen in that line (1)
</li>
<li>sum the times seen, check threshold, yield pair
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-17" class="outline-2">
<h2 id="sec-17"><span class="section-number-2">17</span> Discussion: User Visits&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span>&#xa0;<span class="animate">animate</span></span></h2>
<div class="outline-text-2" id="text-17">
<ul class="org-ul">
<li>Can we calculate the number of visits per user?
</li>
<li>No! User information on different line
</li>
<li>Cannot assume linear processing
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-18" class="outline-2">
<h2 id="sec-18"><span class="section-number-2">18</span> Transform Data&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-18">
<ul class="org-ul">
<li>MapReduce needs all information on one line
</li>
<li>This data format has user information on different line than visit
</li>
<li>Write single threaded program (not mrjob) to transform it
</li>
</ul>
</div>
<div id="outline-container-sec-18-1" class="outline-3">
<h3 id="sec-18-1"><span class="section-number-3">18.1</span> Not covered&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h3>
<div class="outline-text-3" id="text-18-1">
<ul class="org-ul">
<li>This is a little out of the scope of this tutorial
</li>
<li>Just know that not all types of data are amenable to MapReduce, and
</li>
</ul>
<p>
Hadoop/mrjob specifically
</p>
</div>
</div>
</div>
<div id="outline-container-sec-19" class="outline-2">
<h2 id="sec-19"><span class="section-number-2">19</span> Most Common Title Words&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-19">
<ul class="org-ul">
<li>Vroots (pages) have titles
</li>
<li>What are the titles of the 10 most browsed nodes?
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-20" class="outline-2">
<h2 id="sec-20"><span class="section-number-2">20</span> Joins&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span>&#xa0;<span class="two_col">two_col</span></span></h2>
<div class="outline-text-2" id="text-20">
<ul class="org-ul">
<li>Sometimes need to join against two data sets
</li>
<li>In our case, it is the same file, different record types
</li>
<li>mrjob can pass serializable objects between Map and Reduce steps
</li>
</ul>

<div class="org-src-container">

<pre class="src src-csv">A<span style="color: #ff0000;">,</span>1012<span style="color: #ff0000;">,</span>1<span style="color: #ff0000;">,</span><span style="color: #8b2252;">"Outlook Development"</span><span style="color: #ff0000;">,</span><span style="color: #8b2252;">"/outlookdev"</span>
...
V<span style="color: #ff0000;">,</span>1012<span style="color: #ff0000;">,</span>1
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-21" class="outline-2">
<h2 id="sec-21"><span class="section-number-2">21</span> Running Programatically&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-21">
<ul class="org-ul">
<li>We've been running in the command line
</li>
<li>How to process the output of an MRJob inline
</li>
<li>Testing, insert results into a database, do further processing on all of
</li>
</ul>
<p>
result
</p>
</div>
</div>
<div id="outline-container-sec-22" class="outline-2">
<h2 id="sec-22"><span class="section-number-2">22</span> MRJob Class&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-22">
<div class="org-src-container">

<pre class="src src-python"><span style="color: #a0522d;">mr_job</span> = MRJobSubclass(args=[...])
<span style="color: #a020f0;">with</span> mr_job.make_runner() <span style="color: #a020f0;">as</span> runner:
    runner.run()
    runner.stream_output()
</pre>
</div>
</div>
<div id="outline-container-sec-22-1" class="outline-3">
<h3 id="sec-22-1"><span class="section-number-3">22.1</span> Example&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h3>
<div class="outline-text-3" id="text-22-1">
<ul class="org-ul">
<li><code>code/top\_titles.py</code>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-23" class="outline-2">
<h2 id="sec-23"><span class="section-number-2">23</span> <b>BREAK</b>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-23">
<ul class="org-ul">
<li>Please complete exercise 2
</li>
<li>Fill in <code>code/count\_titles.py</code>
</li>
<li>Examine and run with <code>code/top\_titles.py</code>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-24" class="outline-2">
<h2 id="sec-24"><span class="section-number-2">24</span> Solution&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-24">
<ul class="org-ul">
<li><code>git checkout ex2</code>
</li>
<li>yield a tuple tagged with either 'A' or 'V'
</li>
<li>When iterating through values, extract the data from the tagged tuple
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-25" class="outline-2">
<h2 id="sec-25"><span class="section-number-2">25</span> Yelp Data&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-25">
<ul class="org-ul">
<li>Subset of data available in  <code>yelp/selected_reviews.json=</code>
</li>
</ul>
<div class="org-src-container">

<pre class="src src-json">{"votes": {"funny": 3, "useful": 3, "cool": 2},
 "user_id": "dYtkphUrU7S2_bjif6k2uA",
 "review_id": "gjtWdiEMMfoOTCfdd3hPmA",
 "stars": 4,
 "date": "2009-04-24",
 "text": "Man, if these guys were trying to replicate a gringo bar in Mexico...",
 "type": "review",
 "business_id": "RqbSeoeqXTwts5pfhw7nJg"}
</pre>
</div>
</div>
<div id="outline-container-sec-25-1" class="outline-3">
<h3 id="sec-25-1"><span class="section-number-3">25.1</span> More Data&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h3>
<div class="outline-text-3" id="text-25-1">
<ul class="org-ul">
<li>You may run with more data by downloading and extracting from
     <a href="http://www.yelp.com/dataset_challenge">http://www.yelp.com/dataset_challenge</a>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-26" class="outline-2">
<h2 id="sec-26"><span class="section-number-2">26</span> Multi-Step&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-26">
<ul class="org-ul">
<li>Not all computations can be done in a single MapReduce step
</li>
<li>Map Input: &lt;key, value&gt;
</li>
<li>Reducer Output: &lt;key, value&gt;
</li>
<li>Compose MapReduce steps!
</li>
</ul>
</div>
<div id="outline-container-sec-26-1" class="outline-3">
<h3 id="sec-26-1"><span class="section-number-3">26.1</span> Output as Input&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h3>
<div class="outline-text-3" id="text-26-1">
<ul class="org-ul">
<li>The output of one MapReduce job can be used as the input to another
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-26-2" class="outline-3">
<h3 id="sec-26-2"><span class="section-number-3">26.2</span> Examples&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-26-2">
<ul class="org-ul">
<li>PageRank: Multiple steps till solution converges
</li>
<li>Multi-level summaries
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-26-3" class="outline-3">
<h3 id="sec-26-3"><span class="section-number-3">26.3</span> PageRank&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h3>
<div class="outline-text-3" id="text-26-3">
<ul class="org-ul">
<li>PageRank is an algorithm for calculating the important of a page
</li>
<li>But it depends on the importance of every page pointing to it!
</li>
<li>So iteratively calculate the important of all pages
</li>
<li>Find average presidential donations by candidate, then normalize averages
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-27" class="outline-2">
<h2 id="sec-27"><span class="section-number-2">27</span> Unique Review&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span>&#xa0;<span class="animate">animate</span></span></h2>
<div class="outline-text-2" id="text-27">
<ul class="org-ul">
<li>Count unique words per review
</li>
<li>Map Input: &lt;line number, text&gt;
</li>
<li>Map Output: &lt;word, review\<sub>id</sub>&gt;
</li>
<li>Reducer Input: &lt;word, [review\<sub>ids]</sub>&gt;
</li>
<li>Reducer Output: &lt;review\<sub>id</sub>, 1&gt; if the word is unique
</li>
</ul>
</div>
<div id="outline-container-sec-27-1" class="outline-3">
<h3 id="sec-27-1"><span class="section-number-3">27.1</span> Questions&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h3>
<div class="outline-text-3" id="text-27-1">
<ul class="org-ul">
<li>For our purposes, what is always the mapper input?
</li>
<li>What feature do we want to calculate first?
</li>
<li>Given this mapper output, what <b>must</b> the reducer input be?
</li>
<li>What property about a review are we interested in?
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-27-2" class="outline-3">
<h3 id="sec-27-2"><span class="section-number-3">27.2</span> Step 2: Count Unique Words&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span>&#xa0;<span class="animate">animate</span></span></h3>
<div class="outline-text-3" id="text-27-2">
<ul class="org-ul">
<li>Map Input: &lt;review\<sub>id</sub>, 1&gt;
</li>
<li>Map Output: &lt;review\<sub>id</sub>, 1&gt;
</li>
<li>Reducer Input: &lt;review\<sub>id</sub>, [1,1,&#x2026;]&gt;
</li>
<li>Reducer Output: &lt;review\<sub>id</sub>, sum&gt;
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-27-3" class="outline-3">
<h3 id="sec-27-3"><span class="section-number-3">27.3</span> Questions&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h3>
<div class="outline-text-3" id="text-27-3">
<ul class="org-ul">
<li>Given the reducer output, what <b>must</b> the mapper input be (for chained
MapReduce steps)
</li>
<li>What do we want to group by?
</li>
<li>Given this mapper output, what <b>must</b> the reducer input be?
</li>
<li>What are we calculating?
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-28" class="outline-2">
<h2 id="sec-28"><span class="section-number-2">28</span> INPUT<sub>PROTOCOL</sub>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-28">
<ul class="org-ul">
<li>Previous examples manually parsed line
</li>
<li>mrjob provides "protocols" to automatically parse and recover from error
</li>
<li>Specify the class desired to parse the lines
</li>
</ul>
</div>
<div id="outline-container-sec-28-1" class="outline-3">
<h3 id="sec-28-1"><span class="section-number-3">28.1</span> Examples&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h3>
<div class="outline-text-3" id="text-28-1">
<ul class="org-ul">
<li>We're using a JSON object per line. Other options include JSON key-values,
</li>
</ul>
<p>
or writing your own
</p>
<ul class="org-ul">
<li>Instead of raw text, <code>record</code> will now be a Python dict
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-29" class="outline-2">
<h2 id="sec-29"><span class="section-number-2">29</span> <b>BREAK</b>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-29">
<ul class="org-ul">
<li>Please complete exercise 3
</li>
<li>Fill in <code>code/unique\_review.py</code>
</li>
<li>Run with data in <code>yelp/selected_reviews.json</code>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-30" class="outline-2">
<h2 id="sec-30"><span class="section-number-2">30</span> Solution&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-30">
<ul class="org-ul">
<li>Extract words from the review comment field
</li>
<li>Group them by word, keep those that are unique
</li>
<li>Group them by review, return sum
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-31" class="outline-2">
<h2 id="sec-31"><span class="section-number-2">31</span> Jaccard Coefficient&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-31">
<ul class="org-ul">
<li>Commonly used for calculating set similarity
</li>
<li><code>|intersection| / |union|</code>
</li>
<li>"Jim likes pizza" | "Shreyas likes pizza"
</li>
</ul>
</div>
<div id="outline-container-sec-31-1" class="outline-3">
<h3 id="sec-31-1"><span class="section-number-3">31.1</span> Jaccard&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h3>
<div class="outline-text-3" id="text-31-1">
<ol class="org-ol">
<li>Break up into a set
</li>
<li>calculate # in intersection
</li>
<li>calculate # in union
</li>
<li>divide
</li>
</ol>
</div>
</div>
</div>
<div id="outline-container-sec-32" class="outline-2">
<h2 id="sec-32"><span class="section-number-2">32</span> Write user\<sub>similarity</sub>.py&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-32">
<ul class="org-ul">
<li>Find users &gt;= 0.5 similarity
</li>
<li>User Similarity: Jaccard similarity of businesses reviewed
</li>
<li>{BizA, BizB, BizC} ~ {BizF, BizB, BizG}
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-33" class="outline-2">
<h2 id="sec-33"><span class="section-number-2">33</span> <b>BREAK</b>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-33">
<ul class="org-ul">
<li>Please complete exercise 4
</li>
<li>Fill in <code>code/user\_similarity.py</code>
</li>
<li>Run with data in <code>yelp/selected_reviews.json</code>
</li>
<li>Hint: Users with &gt; 0 similarity will share at least 1 business
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-34" class="outline-2">
<h2 id="sec-34"><span class="section-number-2">34</span> Solution&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-34">
<ul class="org-ul">
<li>Map user to list of businesses reviewed
</li>
<li>Map business to list of user descriptions
</li>
<li>Find users with similarity
</li>
<li>De-duplicate
</li>
</ul>
</div>
<div id="outline-container-sec-34-1" class="outline-3">
<h3 id="sec-34-1"><span class="section-number-3">34.1</span> Efficiency&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h3>
<div class="outline-text-3" id="text-34-1">
<ul class="org-ul">
<li>We do duplicate work, but the trade-off is parallelism in the best case
</li>
</ul>
<p>
(not many users are overlapping with each other for dozens of reviews)
</p>
</div>
</div>
</div>
<div id="outline-container-sec-35" class="outline-2">
<h2 id="sec-35"><span class="section-number-2">35</span> EMR&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-35">
<ul class="org-ul">
<li>We've been using local mode
</li>
<li>Effective for debugging, small amounts of data
</li>
<li>What about actually processing Big Data?
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-36" class="outline-2">
<h2 id="sec-36"><span class="section-number-2">36</span> Elastic MapReduce&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-36">
<ul class="org-ul">
<li>Service by Amazon
</li>
<li>Installs and sets up Hadoop cluster
</li>
<li>Ability to run scripts at setup
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-37" class="outline-2">
<h2 id="sec-37"><span class="section-number-2">37</span> mrjob provides&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-37">
<ul class="org-ul">
<li>Encode standard settings as config file or arguments
</li>
<li>Uploads and runs bootstrap commands w/ local integration
</li>
<li>Transparent inter-job bookkeeping
</li>
<li>Tracking, error collection, job sharing
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-38" class="outline-2">
<h2 id="sec-38"><span class="section-number-2">38</span> How To&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-38">
<div class="org-src-container">

<pre class="src src-shell">python code/unique_review.py -r emr -c mrjob.conf s3://i290-jblomo/data/selected_reviews.json.gz
</pre>
</div>
<ul class="org-ul">
<li>Simply specify <code>-r emr</code>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-39" class="outline-2">
<h2 id="sec-39"><span class="section-number-2">39</span> Settings&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-39">
<ul class="org-ul">
<li>Instance types
</li>
<li>EMR keys
</li>
<li>Location for logs
</li>
<li>SSH key
</li>
<li>Bootstrap behavior
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-40" class="outline-2">
<h2 id="sec-40"><span class="section-number-2">40</span> Bootstrap&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-40">
<ul class="org-ul">
<li>use of # for file uploads
</li>
<li>location of runs (different than raw bootstrap commands)
</li>
<li>installation of python packages
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-41" class="outline-2">
<h2 id="sec-41"><span class="section-number-2">41</span> Book Keeping&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-41">
<ul class="org-ul">
<li>&#x2013;output-dir s3://output-bucket/path/
</li>
<li>&#x2013;no-output
</li>
<li>intermediate results stored on HDFS
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-42" class="outline-2">
<h2 id="sec-42"><span class="section-number-2">42</span> Tracking&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span>&#xa0;<span class="two_col">two_col</span></span></h2>
<div class="outline-text-2" id="text-42">
<ul class="org-ul">
<li>mrjob opens an SSH tunnel to the master node for Hadoop stats
</li>
<li>On job failure, will download logs and use heuristics to find likely error
</li>
</ul>

<div class="figure">
<p><img src="img/HadoopUI.png"  alt="HadoopUI.png"/></p>
</div>
</div>
</div>
<div id="outline-container-sec-43" class="outline-2">
<h2 id="sec-43"><span class="section-number-2">43</span> EMR Pricing&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-43">
<ul class="org-ul">
<li>Job flows are billed hourly, rounding <b>up</b>
</li>
</ul>

<div class="figure">
<p><img src="img/jobflow-no-pooling.png"  alt="jobflow-no-pooling.png"/></p>
</div>
</div>
<div id="outline-container-sec-43-1" class="outline-3">
<h3 id="sec-43-1"><span class="section-number-3">43.1</span> Typical usage&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h3>
<div class="outline-text-3" id="text-43-1">
<ul class="org-ul">
<li>Spin up a job flow, when finished, kill it
</li>
<li>Remaining time and end of last hour is wasted
</li>
<li>Billed for it, but not used
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-43-2" class="outline-3">
<h3 id="sec-43-2"><span class="section-number-3">43.2</span> Job Flow Pooling&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h3>
<div class="outline-text-3" id="text-43-2">
<ul class="org-ul">
<li>Don't end job flow after job, share remaining time
</li>
</ul>

<div class="figure">
<p><img src="img/jobflow-pooling.png"  alt="jobflow-pooling.png"/></p>
</div>
<ul class="org-ul">
<li>New jobs can wait N minutes for an idle flow
</li>
</ul>
</div>
<div id="outline-container-sec-43-2-1" class="outline-4">
<h4 id="sec-43-2-1"><span class="section-number-4">43.2.1</span> Pooling&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notes">notes</span></span></h4>
<div class="outline-text-4" id="text-43-2-1">
<ul class="org-ul">
<li>Billed on the hour, so don't give up early!
</li>
<li>Only shut down idle job flows at the end of the hour
</li>
<li>If another job comes up, reuse idle flow
</li>
<li>Also makes job faster to spin up BONUS for developers
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-44" class="outline-2">
<h2 id="sec-44"><span class="section-number-2">44</span> mrjob Workflow&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-44">
<ul class="org-ul">
<li>Develop locally on subset of data
</li>
<li>Run on EMR on all data located in S3 bucket
</li>
<li>Either save output in S3, or stream locally
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-45" class="outline-2">
<h2 id="sec-45"><span class="section-number-2">45</span> Thank You!&#xa0;&#xa0;&#xa0;<span class="tag"><span class="slide">slide</span></span></h2>
<div class="outline-text-2" id="text-45">
<ul class="org-ul">
<li>Jim Blomo, Engineering Manager Yelp
</li>
<li>@jimblomo
</li>
</ul>

<script type="text/javascript" src="production/org-html-slideshow.js"></script>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Jim Blomo</p>
<p class="date">Created: 2014-04-08 Tue 03:30</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 23.4.1 (<a href="http://orgmode.org">Org</a> mode 8.0.6)</p>
<p class="xhtml-validation"><a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a></p>
</div>
</body>
</html>
